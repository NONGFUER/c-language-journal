
# 动态内存分配

## 静态内存分配
一些数据、变量、对象，在编译时已经分配了存储空间。

## 动态内存分配
不知道开辟多少空间，灵活分配内存空间。

## 堆区和栈区的概念
- **stack**：栈（用于存放局部变量）
- **heap**：堆（用于存放动态变量，存放 malloc 和 new 申请空间）

## 堆与栈的区别
- 管理方式不同
- 空间大小不同
- 生长方向不同
- 分配方式不同
- 存放内容不同

动态内存都是在堆区进行分配的。

## 动态内存分配相关的函数

### malloc() 函数
```c
void *malloc(size_t size); // 参数 size 为申请空间大小
```

### free() 函数
```c
void free(void *ptr); // 参数 ptr 为释放的空间地址
```

### calloc() 函数
```c
void *calloc(size_t nmemb, size_t size); // 参数 nmemb 为申请空间个数，size 为每个空间大小
```

### realloc() 函数
```c
void *realloc(void *ptr, size_t size); // 参数 ptr 为原空间地址，size 为申请空间大小
```

## 什么叫内存泄露
函数调用结束，没有释放动态分配的空间，导致空间无法回收，造成内存泄漏。
> free 必须释放动态分配的空间。

## calloc 与 malloc 的区别
- 想初始化用 calloc，不初始化用 malloc。
- calloc = malloc + memset。

## realloc 的操作方式
1. 空间不够用，申请新的空间，将原空间内容拷贝到新空间，释放原空间。
2. 空间够用，直接拼接新空间。

`realloc(NULL, 40)` 等价于 `malloc(40)`。

**应用：通讯录动态增长的版本**

---

## 常见的动态内存错误
1. 空指针
2. 动态开辟空间的越界访问
3. 对非动态分配的空间进行释放
4. 使用 free 释放一块动态分配空间的一部分
5. 对同一块动态内存多次释放
6. 动态开辟内存忘记释放（内存泄露）

## 柔性数组
柔性数组是一种动态数组，数组的长度可以动态改变。结构体中最后一个元素允许是大小未知的数组。

```c
typedef struct st_type {
    int i;
    int a[0]; // 柔性数组成员
} type_a;
```